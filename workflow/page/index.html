
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Guidance</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="feather.css">
    <link rel="stylesheet" href="app.css">
 
    <style>

        :root {
            --blue: #133371;
            --blue-light: #1b469d;
            --red: #a53535;
            --gray: #999;
        }
        body {
            border-top: 8px solid var(--blue);
            padding-bottom: 120px;
        }

        .option {
            padding: 8px;
            line-height: 22px;
            border: 1px solid var(--blue);
            color: var(--blue);
            transition: all .4s;
        }

        .option-warning {
            font-size: 10px;
            font-weight: bold;
            color: #d18800;
        }

        .option:hover:not(.disabled) {
            background: var(--blue-light);
            color: white;
            cursor: pointer;
        }

        .selected {
            background: var(--blue);
            color: white;
            font-weight: bold;
        }

        .disabled, .disabled:hover {
            border: 1px solid var(--gray);
            color: #999;
            cursor: not-allowed;
            text-decoration: none;
            opacity: .6;
        } 

        #json-log {
            font-size: 10px;
            max-height: 400px
        }

        .path-item {
            margin-right: 4px;
            font-size: 12px;
            padding: 0px 4px;
            line-height: 1.8;
        }

        .path-item:last-child {
            border: 0;
            pointer-events: none;
            background: none;
        }

        #note {
            display: block;
            font-size: 13px;
            color: palevioletred;
            padding: 8px;
            font-weight: bold;
        }

        #dati-fascicolo {

        }
        

    </style>

</head>
<body>
    
  
  

<div class="container-fluid">
    <div class="row d-flex">
        <div class="col-md-2  pt-5">
            Dati estratti dal fascicolo: 
            <pre id="log-dati-fascicolo"></pre>
        </div>
        <div class="col-md-1 brd-right"></div>
        <div class="col-md-4 col-md-offset-1  pt-5">
            <small id="path"></small>
            <h2 id="question-title" class="title"></h2>
            <p id="question-description"></p>
    
            <div id="options-wrapper"></div>

            <hr>

            <div id="note" class="well"></div>

            <pre id="json-log"></pre>
            <a href="" id="filename-log" target="_blank"></pre>
        </div>
    </div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>


<script>
    const qTitle = document.getElementById('question-title');
    const qDesc = document.getElementById('question-description');
    const optsWrapper = document.getElementById('options-wrapper');
    const filenameLog = document.getElementById('filename-log');
    const jsonLog = document.getElementById('json-log');
    const path = document.getElementById('path');
    const note = document.getElementById('note');
    const logDatiFascicolo = document.getElementById('log-dati-fascicolo');

    const dataUrl = "https://raw.githubusercontent.com/afalchi82/rdtr_workflow/master/data/";

    let history = [];

    const datiFascicolo = {
        materia: "lavoro"
    };


    /* ---------------------------------------------------
        Functions
    --------------------------------------------------- */

    function emptyEl (el) {
        while (el.firstChild) {
            el.removeChild(el.firstChild);
        }
    } 


    function resetStage () {                    
        [optsWrapper, filenameLog, path, note].forEach(el => emptyEl(el));
        
        qDesc.style.display = "block";
        note.style.display = "none";

        filenameLog.setAttribute('href', "");
    }


    function buildOption (optObj) {
        const wrapper = document.createElement("div");
        // wrapper.classList.add('col-md-6');
        wrapper.classList.add('mb-1');

        const opt = document.createElement("div");
        opt.innerText = optObj.label;
        opt.setAttribute('title', optObj.description || '');
        opt.classList.add('option');
        
        if (!optObj.child || optObj.disabled) {
            opt.classList.add('disabled');
        } else {
            opt.addEventListener("click", function (ev) {
                ev.target.classList.add("selected");
                setTimeout(() => {
                    loadData(optObj.child);
                }, 400);
            });
        }

        wrapper.appendChild(opt);

        // Check dati fascicolo
        if (datiFascicolo && optObj.if) {
            Object.keys(optObj.if).forEach(k => {
                if (optObj.if[k] !== datiFascicolo[k]) {
                    const warning = document.createElement("p");
                    warning.innerText = `Attenzione: scelta in contrasto col valore "${k}" del fascicolo.`;
                    warning.classList.add('option-warning');
                    wrapper.appendChild(warning);
                };
            });
        }

        
        return wrapper;
    }


    function buildPathItem (id) {
        const step = document.createElement("button");
        step.innerText = id || "[id]";
        step.classList.add('path-item');
        step.addEventListener("click", function (ev) {
            loadData(id);
        });
        return step;
    }


    function buildStage (stageObj) {
        resetStage();

        if(stageObj.question) {
            qTitle.innerHTML = stageObj.question;
            stageObj.options.forEach(item => {
                optsWrapper.appendChild(buildOption(item));
            });
        } else {
            qTitle.innerHTML = "Risultato della ricerca";
        }

        stageObj.description ? qDesc.innerHTML = stageObj.description : qDesc.style.display = "none";

        updatePath(stageObj.id);

        // Debug
        jsonLog.innerHTML = JSON.stringify(stageObj, null, 2);
        if (stageObj._note) {
            note.innerHTML = stageObj._note;
            note.style.display = "block";
        }
        filenameLog.innerText = stageObj._filename;
        filenameLog.setAttribute('href', getRemoteFilePath(stageObj._filename));

        
    }


    function getRemoteFilePath (filename) {
        return `https://www.dropbox.com/sh/wb1d2s7w9w09yl3/AABMfFLSp62PbJt53SgIDsIna?dl=0&preview=${filename.replace(" ", "+")}.pdf`;
    }


    function loadData (id) {
        const url = dataUrl + id + ".json";
        $.ajax({
            cache: false,
            url,
            dataType: "json",
            success( data ) {
                buildStage(data);
            },
            error( err ) {
                console.log(err)
                alert( "ERROR:  " + err.statusText );
            },
            headers: {"Authorization": 'token AAO35IQRS4M5YY5O25CICBTACFDAW'}
        });
    } 


    function updatePath (id) {
        emptyEl(path);

        const index = history.indexOf(id);
        if (index === -1) {
            history.push(id);
        } else {
            history = history.filter((el, i) => i <= index);
        }

        history.forEach(item => {
            path.appendChild(buildPathItem(item));
        });

    }


    /* ---------------------------------------------------
        Init
    --------------------------------------------------- */

    logDatiFascicolo.innerHTML = JSON.stringify(datiFascicolo, null, 2);
    
    loadData("index");



</script>



</body>
</html>
